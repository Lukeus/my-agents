name: Deploy to AKS

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        type: choice
        options:
          - dev
          - staging
          - prod
      image_tag:
        description: 'Docker image tag to deploy'
        required: true
        type: string

env:
  AZURE_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
  RESOURCE_GROUP: ${{ secrets.AZURE_RESOURCE_GROUP }}
  AKS_CLUSTER_NAME: ${{ secrets.AKS_CLUSTER_NAME }}

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Azure Login
      uses: azure/login@v2
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}
        
    - name: Set AKS context
      uses: azure/aks-set-context@v3
      with:
        resource-group: ${{ env.RESOURCE_GROUP }}
        cluster-name: ${{ env.AKS_CLUSTER_NAME }}
        
    - name: Setup kubectl
      uses: azure/setup-kubectl@v3
      with:
        version: 'latest'
        
    - name: Setup Helm
      uses: azure/setup-helm@v4
      with:
        version: 'latest'
        
    - name: Setup Kustomize
      uses: imranismail/setup-kustomize@v2
      with:
        kustomize-version: 'latest'
        
    - name: Create namespace if not exists
      run: |
        kubectl create namespace agents-${{ github.event.inputs.environment }} --dry-run=client -o yaml | kubectl apply -f -
        
    - name: Create image pull secret
      run: |
        kubectl create secret docker-registry acr-secret \
          --namespace=agents-${{ github.event.inputs.environment }} \
          --docker-server=${{ secrets.ACR_LOGIN_SERVER }} \
          --docker-username=${{ secrets.ACR_USERNAME }} \
          --docker-password=${{ secrets.ACR_PASSWORD }} \
          --dry-run=client -o yaml | kubectl apply -f -
          
    - name: Deploy Azure resources secrets
      run: |
        kubectl create secret generic agents-secrets \
          --namespace=agents-${{ github.event.inputs.environment }} \
          --from-literal=ConnectionStrings__SqlServer="${{ secrets.SQL_CONNECTION_STRING }}" \
          --from-literal=ConnectionStrings__CosmosDb="${{ secrets.COSMOS_CONNECTION_STRING }}" \
          --from-literal=LLMProvider__AzureOpenAI__Endpoint="${{ secrets.AZURE_OPENAI_ENDPOINT }}" \
          --from-literal=LLMProvider__AzureOpenAI__ApiKey="${{ secrets.AZURE_OPENAI_API_KEY }}" \
          --from-literal=LLMProvider__AzureOpenAI__DeploymentName="${{ secrets.AZURE_OPENAI_DEPLOYMENT }}" \
          --from-literal=EventHub__ConnectionString="${{ secrets.EVENT_HUB_CONNECTION_STRING }}" \
          --from-literal=ServiceBus__ConnectionString="${{ secrets.SERVICE_BUS_CONNECTION_STRING }}" \
          --from-literal=ApplicationInsights__ConnectionString="${{ secrets.APP_INSIGHTS_CONNECTION_STRING }}" \
          --dry-run=client -o yaml | kubectl apply -f -
          
    - name: Update Kustomize image tags
      working-directory: k8s/overlays/${{ github.event.inputs.environment }}
      run: |
        kustomize edit set image \
          ${{ secrets.ACR_LOGIN_SERVER }}/agents-notification-api=${{ secrets.ACR_LOGIN_SERVER }}/agents-notification-api:${{ github.event.inputs.image_tag }} \
          ${{ secrets.ACR_LOGIN_SERVER }}/agents-devops-api=${{ secrets.ACR_LOGIN_SERVER }}/agents-devops-api:${{ github.event.inputs.image_tag }} \
          ${{ secrets.ACR_LOGIN_SERVER }}/agents-testplanning-api=${{ secrets.ACR_LOGIN_SERVER }}/agents-testplanning-api:${{ github.event.inputs.image_tag }} \
          ${{ secrets.ACR_LOGIN_SERVER }}/agents-implementation-api=${{ secrets.ACR_LOGIN_SERVER }}/agents-implementation-api:${{ github.event.inputs.image_tag }} \
          ${{ secrets.ACR_LOGIN_SERVER }}/agents-servicedesk-api=${{ secrets.ACR_LOGIN_SERVER }}/agents-servicedesk-api:${{ github.event.inputs.image_tag }}
          
    - name: Deploy with Helm via Kustomize
      run: |
        helm upgrade --install agents ./helm/agents \
          --namespace agents-${{ github.event.inputs.environment }} \
          --values helm/agents/values.yaml \
          --values helm/agents/values-${{ github.event.inputs.environment }}.yaml \
          --set image.registry=${{ secrets.ACR_LOGIN_SERVER }} \
          --set image.tag=${{ github.event.inputs.image_tag }} \
          --wait \
          --timeout 10m
          
    - name: Verify deployment
      run: |
        kubectl rollout status deployment -n agents-${{ github.event.inputs.environment }} -l app.kubernetes.io/name=agents
        kubectl get pods -n agents-${{ github.event.inputs.environment }}
        
    - name: Run smoke tests
      run: |
        # Wait for all pods to be ready
        kubectl wait --for=condition=ready pod -n agents-${{ github.event.inputs.environment }} -l app.kubernetes.io/name=agents --timeout=300s
        
        # Get service endpoints and test health
        for service in notification devops testplanning implementation servicedesk; do
          echo "Testing $service health endpoint..."
          kubectl run curl-test-$service --image=curlimages/curl:latest --rm -i --restart=Never \
            --namespace=agents-${{ github.event.inputs.environment }} \
            -- curl -f http://agents-$service/health || exit 1
        done

  notify:
    runs-on: ubuntu-latest
    needs: deploy
    if: always()
    
    steps:
    - name: Notify deployment result
      uses: 8398a7/action-slack@v3
      with:
        status: ${{ job.status }}
        text: |
          Deployment to ${{ github.event.inputs.environment }} environment
          Status: ${{ job.status }}
          Image tag: ${{ github.event.inputs.image_tag }}
        webhook_url: ${{ secrets.SLACK_WEBHOOK }}
      if: always()
